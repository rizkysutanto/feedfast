<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeedFast - Report</title>
    <link rel="stylesheet" href="/css/client-dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="/logo-feedfast.webp" alt="FeedFast">
                <div class="logo-text">
                    <span class="brand-name">FeedFast</span>
                    <span class="company-name" id="sidebarClientName">Loading...</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <img src="/icon-dashboard.png" alt="" class="nav-icon">
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/ticket" class="nav-link">
                        <img src="/icon-ticket.png" alt="" class="nav-icon">
                        Ticket
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/branch" class="nav-link">
                        <img src="/icon-branch.png" alt="" class="nav-icon">
                        Branch
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/report" class="nav-link active">
                        <img src="/icon-report.png" alt="" class="nav-icon">
                        Report
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/usermanagement" class="nav-link">
                        <img src="/icon-usermanagement.png" alt="" class="nav-icon">
                        User Management
                    </a>
                </div>
                <div class="nav-item">
                    <a href="settings" class="nav-link">
                        <img src="/icon-settings.png" alt="" class="nav-icon">
                        Settings
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-content">
                    <div class="user-info">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-role" id="userRole">Loading...</span>
                        <div class="user-avatar" id="userAvatar">L</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="content-area">
                <div class="error-message" id="errorMessage" style="display: none;"></div>

                <!-- Report Header -->
                <div class="report-header">
                    <div class="report-title-section">
                        <h1 class="report-title">Report</h1>
                        <p class="report-subtitle">Analyze your company feedback</p>
                    </div>
                    <button class="btn btn-primary export-btn" onclick="exportCSV()">Export CSV</button>
                </div>

                <!-- Key Performance Indicator Section -->
                <div class="kpi-section">
                    <div class="kpi-header">
                        <div class="kpi-title-section">
                            <h2 class="kpi-title">Key Performance Indicator</h2>
                            <p class="kpi-date" id="kpiDateRange">01 Jan 2025 - 31 Dec 2025</p>
                        </div>
                        
                        <div class="kpi-filters">
                            <div class="filter-group">
                                <select id="periodFilter" class="filter-select">
                                    <option value="annually">Annually</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select id="rangeFilter" class="filter-select">
                                    <!-- Will be populated based on period selection -->
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select id="branchFilter" class="filter-select">
                                    <option value="all">All Branch</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- KPI Stats Row 1 -->
                    <div class="kpi-stats-row">
                        <div class="kpi-card kpi-card-purple">
                            <div class="kpi-content">
                                <div class="kpi-number" id="totalTickets">0</div>
                                <div class="kpi-label">Total Ticket</div>
                            </div>
                            <div class="kpi-icon-container">
                                <div class="kpi-icon-circle kpi-icon-purple">
                                    <img src="/icon-ticket.png" alt="" class="kpi-icon">
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-card-red">
                            <div class="kpi-content">
                                <div class="kpi-number" id="complaintTickets">0</div>
                                <div class="kpi-label">Complaint</div>
                            </div>
                            <div class="kpi-icon-container">
                                <div class="kpi-icon-circle kpi-icon-red">
                                    <img src="/icon-ticket.png" alt="" class="kpi-icon">
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-card-yellow">
                            <div class="kpi-content">
                                <div class="kpi-number" id="suggestionTickets">0</div>
                                <div class="kpi-label">Suggestion</div>
                            </div>
                            <div class="kpi-icon-container">
                                <div class="kpi-icon-circle kpi-icon-yellow">
                                    <img src="/icon-ticket.png" alt="" class="kpi-icon">
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-card-blue">
                            <div class="kpi-content">
                                <div class="kpi-number" id="inquiryTickets">0</div>
                                <div class="kpi-label">Inquiry</div>
                            </div>
                            <div class="kpi-icon-container">
                                <div class="kpi-icon-circle kpi-icon-blue">
                                    <img src="/icon-ticket.png" alt="" class="kpi-icon">
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card kpi-card-green">
                            <div class="kpi-content">
                                <div class="kpi-number" id="complimentTickets">0</div>
                                <div class="kpi-label">Compliment</div>
                            </div>
                            <div class="kpi-icon-container">
                                <div class="kpi-icon-circle kpi-icon-green">
                                    <img src="/icon-ticket.png" alt="" class="kpi-icon">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Replace the KPI Stats Row 2 section in your HTML with this: -->
<div class="kpi-stats-row">
    <div class="kpi-card kpi-card-gray">
        <div class="kpi-content">
            <div class="kpi-number" id="ticketResolved">0</div>
            <div class="kpi-label">Ticket Resolved</div>
        </div>
    </div>

    <div class="kpi-card kpi-card-gray">
        <div class="kpi-content">
            <div class="kpi-number" id="ticketUnresolved">0</div>
            <div class="kpi-label">Ticket Unresolved</div>
        </div>
    </div>

    <div class="kpi-card kpi-card-gray">
        <div class="kpi-content">
            <div class="kpi-time" id="avgResponseTime1">N/A</div>
            <div class="kpi-label">Avg Response Time</div>
        </div>
    </div>

    <div class="kpi-card kpi-card-gray">
        <div class="kpi-content">
            <div class="kpi-time" id="avgResponseTime2">N/A</div>
            <div class="kpi-label">Avg Resolved Time</div>
        </div>
    </div>

    <!-- Third card will be hidden by JavaScript -->
    <div class="kpi-card kpi-card-gray" style="display: none;">
        <div class="kpi-content">
            <div class="kpi-time" id="avgResponseTime3">N/A</div>
            <div class="kpi-label">Unused</div>
        </div>
    </div>
</div>

                <!-- Feedback Volume Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h3 class="chart-title">Feedback Volume</h3>
                        <p class="chart-subtitle" id="chartDateRange">Date Range: 01 Jan 2025 - 31 Dec 2025</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="feedbackChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <style>
        /* Additional styles for Report page */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
        }

        .report-title-section {
            flex: 1;
        }

        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-purple);
            margin: 0 0 0.25rem 0;
            line-height: 1.2;
        }

        .report-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .export-btn {
            background-color: var(--primary-purple);
            color: var(--text-white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .export-btn:hover {
            background-color: #7c3aed;
            transform: translateY(-1px);
        }

        /* KPI Section */
        .kpi-section {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .kpi-title-section {
            flex: 1;
        }

        .kpi-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.25rem 0;
        }

        .kpi-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .kpi-filters {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            background-color: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(133, 39, 240, 0.1);
        }

        .kpi-stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .kpi-stats-row:last-child {
            margin-bottom: 0;
        }

        .kpi-card {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .kpi-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-card);
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-number, .kpi-time {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.25rem 0;
            line-height: 1;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
            font-weight: 500;
        }

        .kpi-icon-container {
            margin-left: 0.75rem;
        }

        .kpi-icon-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kpi-icon {
            width: 16px;
            height: 16px;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        /* KPI Card Color Variants */
        .kpi-card-purple .kpi-number { color: var(--primary-purple); }
        .kpi-icon-purple { background-color: var(--primary-purple); }

        .kpi-card-red .kpi-number { color: var(--danger-red); }
        .kpi-icon-red { background-color: var(--danger-red); }

        .kpi-card-yellow .kpi-number { color: var(--warning-orange); }
        .kpi-icon-yellow { background-color: var(--warning-orange); }

        .kpi-card-blue .kpi-number { color: var(--info-blue); }
        .kpi-icon-blue { background-color: var(--info-blue); }

        .kpi-card-green .kpi-number { color: var(--success-green); }
        .kpi-icon-green { background-color: var(--success-green); }

        .kpi-card-gray .kpi-number,
        .kpi-card-gray .kpi-time { color: var(--text-primary); }

        /* Chart Section */
        .chart-section {
            background-color: var(--bg-card);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-header {
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.25rem 0;
        }

        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .kpi-stats-row {
                grid-template-columns: repeat(3, 1fr);
            }

            .kpi-filters {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .filter-group {
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .kpi-header {
                flex-direction: column;
                align-items: stretch;
            }

            .kpi-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .kpi-card {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            .kpi-icon-container {
                margin-left: 0;
                margin-top: 0.5rem;
            }

            .chart-container {
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .kpi-stats-row {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Global variables
        let currentUser = null;
        let clientToken = null;
        let branches = [];
        let feedbackChart = null;
        let currentFilters = {
            period: 'annually',
            range: new Date().getFullYear().toString(),
            branch: 'all'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Report page initializing...');
            
            // Check authentication
            if (!checkAuth()) {
                return;
            }

            // Load user data and initialize
            await loadUserData();
            await loadBranches();
            initializeFilters();
            await loadReportData();
        });

        // Check authentication
        function checkAuth() {
            clientToken = localStorage.getItem('clientToken');
            const clientUserData = localStorage.getItem('clientUser');

            if (!clientToken) {
                console.log('No client token found, redirecting to login');
                window.location.href = '/login';
                return false;
            }

            if (clientUserData) {
                try {
                    currentUser = JSON.parse(clientUserData);
                    console.log('User data loaded:', currentUser);
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    localStorage.removeItem('clientUser');
                }
            }

            return true;
        }

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch('/api/auth/client-verify', {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token verification failed');
                }

                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    localStorage.setItem('clientUser', JSON.stringify(data.user));
                    updateUserUI();
                } else {
                    throw new Error('Invalid user data received');
                }

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user data. Please try logging in again.');
                setTimeout(() => {
                    logout();
                }, 2000);
            }
        }

        // Update UI with user information
        function updateUserUI() {
            if (!currentUser) return;

            const elements = {
                userName: document.getElementById('userName'),
                userRole: document.getElementById('userRole'),
                userAvatar: document.getElementById('userAvatar'),
                sidebarClientName: document.getElementById('sidebarClientName')
            };

            if (elements.userName) elements.userName.textContent = currentUser.user_name || currentUser.name || 'User';
            if (elements.userRole) elements.userRole.textContent = currentUser.role || 'Client Admin';
            if (elements.sidebarClientName) elements.sidebarClientName.textContent = currentUser.clientName || currentUser.client_name || 'Company';
            
            if (elements.userAvatar) {
                const name = currentUser.user_name || currentUser.name || 'U';
                const initials = name.substring(0, 1).toUpperCase();
                elements.userAvatar.textContent = initials;
            }
        }

        // Load branches for filter
        async function loadBranches() {
            try {
                const response = await fetch('/api/branches', {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    branches = data.branches || [];
                    
                    // Populate branch filter
                    const branchFilter = document.getElementById('branchFilter');
                    branchFilter.innerHTML = '<option value="all">All Branch</option>';
                    
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.branch_id;
                        option.textContent = branch.branch_name;
                        branchFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading branches:', error);
            }
        }

        // Initialize filters
        function initializeFilters() {
            const periodFilter = document.getElementById('periodFilter');
            const rangeFilter = document.getElementById('rangeFilter');
            
            // Set up event listeners
            periodFilter.addEventListener('change', updateRangeFilter);
            rangeFilter.addEventListener('change', updateFilters);
            document.getElementById('branchFilter').addEventListener('change', updateFilters);
            
            // Initialize range filter
            updateRangeFilter();
        }

        // Update range filter based on period selection
        function updateRangeFilter() {
            const periodFilter = document.getElementById('periodFilter');
            const rangeFilter = document.getElementById('rangeFilter');
            const period = periodFilter.value;
            
            rangeFilter.innerHTML = '';
            
            if (period === 'annually') {
                // Show year options
                const currentYear = new Date().getFullYear();
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year.toString();
                    option.textContent = year.toString();
                    rangeFilter.appendChild(option);
                }
                currentFilters.period = 'annually';
                currentFilters.range = currentYear.toString();
            } else if (period === 'monthly') {
                // Show month options for current year
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();
                
                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = `${currentYear}-${String(index + 1).padStart(2, '0')}`;
                    option.textContent = `${month} ${currentYear}`;
                    if (index === currentMonth) {
                        option.selected = true;
                    }
                    rangeFilter.appendChild(option);
                });
                
                currentFilters.period = 'monthly';
                currentFilters.range = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            }
            
            updateFilters();
        }

        // Update filters and reload data
        function updateFilters() {
            const periodFilter = document.getElementById('periodFilter');
            const rangeFilter = document.getElementById('rangeFilter');
            const branchFilter = document.getElementById('branchFilter');
            
            currentFilters = {
                period: periodFilter.value,
                range: rangeFilter.value,
                branch: branchFilter.value
            };
            
            updateDateRangeDisplay();
            loadReportData();
        }

        // Update date range display
        function updateDateRangeDisplay() {
            const kpiDateRange = document.getElementById('kpiDateRange');
            const chartDateRange = document.getElementById('chartDateRange');
            
            let dateRangeText = '';
            
            if (currentFilters.period === 'annually') {
                dateRangeText = `01 Jan ${currentFilters.range} - 31 Dec ${currentFilters.range}`;
            } else if (currentFilters.period === 'monthly') {
                const [year, month] = currentFilters.range.split('-');
                const monthNames = [
                    'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
                ];
                const monthName = monthNames[parseInt(month) - 1];
                const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                dateRangeText = `01 ${monthName} ${year} - ${daysInMonth} ${monthName} ${year}`;
            }
            
            if (kpiDateRange) kpiDateRange.textContent = dateRangeText;
            if (chartDateRange) chartDateRange.textContent = `Date Range: ${dateRangeText}`;
        }

        // Load report data
        async function loadReportData() {
            try {
                console.log('Loading report data with filters:', currentFilters);
                
                // Build query parameters
                const params = new URLSearchParams();
                params.append('period', currentFilters.period);
                params.append('range', currentFilters.range);
                if (currentFilters.branch !== 'all') {
                    params.append('branchId', currentFilters.branch);
                }

                const response = await fetch(`/api/tickets?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tickets = data.tickets || [];
                    
                    // Process and display data
                    processTicketData(tickets);
                    updateKPICards(tickets);
                    updateChart(tickets);
                } else {
                    console.error('Failed to load tickets');
                    // Set default values
                    setDefaultValues();
                }
                
            } catch (error) {
                console.error('Error loading report data:', error);
                setDefaultValues();
            }
        }

        // Fixed processTicketData function - SIMPLIFIED for client-side filtering
        function processTicketData(tickets) {
            let filteredTickets = [...tickets]; // Create a copy
            
            console.log('Processing tickets:', filteredTickets.length, 'with filters:', currentFilters);
            
            // Filter by date range based on period
            if (currentFilters.period === 'annually') {
                const year = parseInt(currentFilters.range);
                filteredTickets = filteredTickets.filter(ticket => {
                    const ticketDate = new Date(ticket.submitted_at);
                    const ticketYear = ticketDate.getFullYear();
                    console.log('Checking ticket year:', ticketYear, 'against filter year:', year);
                    return ticketYear === year;
                });
            } else if (currentFilters.period === 'monthly') {
                const [year, month] = currentFilters.range.split('-');
                filteredTickets = filteredTickets.filter(ticket => {
                    const ticketDate = new Date(ticket.submitted_at);
                    const ticketYear = ticketDate.getFullYear();
                    const ticketMonth = ticketDate.getMonth() + 1; // getMonth() returns 0-11
                    return ticketYear === parseInt(year) && ticketMonth === parseInt(month);
                });
            }
            
            // Filter by branch - FIX FOR ISSUE 1
            if (currentFilters.branch !== 'all') {
                const branchIdToFilter = parseInt(currentFilters.branch);
                filteredTickets = filteredTickets.filter(ticket => {
                    // Handle case where branch_id might be null or undefined
                    const ticketBranchId = ticket.branch_id ? parseInt(ticket.branch_id) : null;
                    return ticketBranchId === branchIdToFilter;
                });
                console.log('Filtered by branch', branchIdToFilter, 'resulting in', filteredTickets.length, 'tickets');
            }
            
            console.log('Final filtered tickets:', filteredTickets.length);
            return filteredTickets;
        }

        // Modified loadReportData function - remove query parameters since server doesn't use them yet
        async function loadReportData() {
            try {
                console.log('Loading report data with filters:', currentFilters);
                
                // For now, get all tickets and filter client-side
                // Later you can implement the server-side filtering using the provided server code
                const response = await fetch('/api/tickets', {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tickets = data.tickets || [];
                    console.log('Raw tickets received:', tickets.length);
                    
                    // Process and display data
                    const filteredTickets = processTicketData(tickets);
                    updateKPICards(tickets); // Pass original tickets, filtering happens inside
                    updateChart(tickets); // Pass original tickets, filtering happens inside
                } else {
                    console.error('Failed to load tickets');
                    setDefaultValues();
                }
                
            } catch (error) {
                console.error('Error loading report data:', error);
                setDefaultValues();
            }
        }

        // Helper function to format time duration
        function formatDuration(milliseconds) {
            if (!milliseconds || milliseconds <= 0) return 'N/A';
            
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            const remainingHours = hours % 24;
            const remainingMinutes = minutes % 60;
            
            let result = [];
            
            if (days > 0) {
                result.push(`${days}d`);
            }
            if (remainingHours > 0) {
                result.push(`${remainingHours}h`);
            }
            if (remainingMinutes > 0) {
                result.push(`${remainingMinutes}m`);
            }
            
            // If no time components, show less than 1 minute
            if (result.length === 0) {
                return '<1m';
            }
            
            return result.join(' ');
        }

        // Calculate average response time (submitted_at to responded_at)
        function calculateAvgResponseTime(tickets) {
            const ticketsWithResponse = tickets.filter(t => t.responded_at && t.submitted_at);
            
            if (ticketsWithResponse.length === 0) return null;
            
            const totalResponseTime = ticketsWithResponse.reduce((total, ticket) => {
                const submitted = new Date(ticket.submitted_at);
                const responded = new Date(ticket.responded_at);
                return total + (responded - submitted);
            }, 0);
            
            return totalResponseTime / ticketsWithResponse.length;
        }

        // Calculate average resolved time (submitted_at to resolved_at)
        function calculateAvgResolvedTime(tickets) {
            const resolvedTickets = tickets.filter(t => t.resolved_at && t.submitted_at);
            
            if (resolvedTickets.length === 0) return null;
            
            const totalResolvedTime = resolvedTickets.reduce((total, ticket) => {
                const submitted = new Date(ticket.submitted_at);
                const resolved = new Date(ticket.resolved_at);
                return total + (resolved - submitted);
            }, 0);
            
            return totalResolvedTime / resolvedTickets.length;
        }

        // Fixed updateKPICards function
        function updateKPICards(tickets) {
            const filteredTickets = processTicketData(tickets); // Now properly filters by branch too
            
            // Calculate statistics
            const stats = {
                total: filteredTickets.length,
                complaint: filteredTickets.filter(t => t.type === 'complaint').length,
                suggestion: filteredTickets.filter(t => t.type === 'suggestion').length,
                inquiry: filteredTickets.filter(t => t.type === 'inquiry').length,
                compliment: filteredTickets.filter(t => t.type === 'compliment').length,
                resolved: filteredTickets.filter(t => t.status === 'resolved' || t.status === 'closed').length,
                unresolved: filteredTickets.filter(t => t.status === 'open' || t.status === 'in_progress').length
            };
            
            // Calculate average times
            const avgResponseTime = calculateAvgResponseTime(filteredTickets);
            const avgResolvedTime = calculateAvgResolvedTime(filteredTickets);
            
            console.log('Avg response time (ms):', avgResponseTime);
            console.log('Avg resolved time (ms):', avgResolvedTime);
            
            // Update DOM elements
            document.getElementById('totalTickets').textContent = stats.total;
            document.getElementById('complaintTickets').textContent = stats.complaint;
            document.getElementById('suggestionTickets').textContent = stats.suggestion;
            document.getElementById('inquiryTickets').textContent = stats.inquiry;
            document.getElementById('complimentTickets').textContent = stats.compliment;
            document.getElementById('ticketResolved').textContent = stats.resolved;
            document.getElementById('ticketUnresolved').textContent = stats.unresolved;
            
            // Update the first two time cards with real data
            document.getElementById('avgResponseTime1').textContent = formatDuration(avgResponseTime);
            document.getElementById('avgResponseTime2').textContent = formatDuration(avgResolvedTime);
            
            // Hide the third time card since we only need 2
            const thirdTimeCard = document.getElementById('avgResponseTime3');
            if (thirdTimeCard && thirdTimeCard.parentElement) {
                thirdTimeCard.parentElement.style.display = 'none';
            }
        }

        // Fixed updateChart function - FIX FOR ISSUE 2 & 3
        function updateChart(tickets) {
            const ctx = document.getElementById('feedbackChart').getContext('2d');
            const filteredTickets = processTicketData(tickets);
            
            let labels = [];
            let chartData = {};
            
            console.log('Chart: Processing', filteredTickets.length, 'filtered tickets');
            
            // Get branches that have tickets in the filtered data
            const branchesWithData = [];
            if (currentFilters.branch === 'all') {
                // Get all branches that have tickets
                const branchTicketCounts = {};
                filteredTickets.forEach(ticket => {
                    const branchId = ticket.branch_id || 'no-branch';
                    branchTicketCounts[branchId] = (branchTicketCounts[branchId] || 0) + 1;
                });
                
                console.log('Branch ticket counts:', branchTicketCounts);
                
                // Find branch names for branches with data
                Object.keys(branchTicketCounts).forEach(branchId => {
                    if (branchId === 'no-branch') {
                        branchesWithData.push({
                            id: 'no-branch',
                            name: 'No Branch',
                            count: branchTicketCounts[branchId]
                        });
                    } else {
                        const branch = branches.find(b => b.branch_id === parseInt(branchId));
                        if (branch) {
                            branchesWithData.push({
                                id: parseInt(branchId),
                                name: branch.branch_name,
                                count: branchTicketCounts[branchId]
                            });
                        }
                    }
                });
            } else {
                // Single branch selected
                const selectedBranch = branches.find(b => b.branch_id === parseInt(currentFilters.branch));
                if (selectedBranch) {
                    branchesWithData.push({
                        id: selectedBranch.branch_id,
                        name: selectedBranch.branch_name,
                        count: filteredTickets.length
                    });
                }
            }
            
            // If no branches with data, show empty chart
            if (branchesWithData.length === 0) {
                branchesWithData.push({
                    id: 'no-data',
                    name: 'No Data',
                    count: 0
                });
            }
            
            console.log('Branches with data:', branchesWithData);
            
            if (currentFilters.period === 'annually') {
                // Show monthly data for the year
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Initialize data structure for each branch
                branchesWithData.forEach(branch => {
                    chartData[branch.id] = new Array(12).fill(0);
                });
                
                // Group tickets by month and branch
                filteredTickets.forEach(ticket => {
                    const ticketDate = new Date(ticket.submitted_at);
                    const month = ticketDate.getMonth(); // 0-11
                    const branchId = ticket.branch_id || 'no-branch';
                    
                    console.log('Ticket date:', ticket.submitted_at, 'Month:', month, 'Branch:', branchId);
                    
                    if (chartData[branchId]) {
                        chartData[branchId][month]++;
                    }
                });
                
            } else if (currentFilters.period === 'monthly') {
                // Show daily data for the month
                const [year, month] = currentFilters.range.split('-');
                const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                
                labels = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    labels.push(day.toString());
                }
                
                // Initialize data structure for each branch
                branchesWithData.forEach(branch => {
                    chartData[branch.id] = new Array(daysInMonth).fill(0);
                });
                
                // Group tickets by day and branch
                filteredTickets.forEach(ticket => {
                    const ticketDate = new Date(ticket.submitted_at);
                    const day = ticketDate.getDate() - 1; // 0-based index
                    const branchId = ticket.branch_id || 'no-branch';
                    
                    if (chartData[branchId] && day >= 0 && day < daysInMonth) {
                        chartData[branchId][day]++;
                    }
                });
            }
            
            console.log('Chart data by branch:', chartData);
            
            // Destroy existing chart
            if (feedbackChart) {
                feedbackChart.destroy();
            }
            
            // Create datasets for each branch
            const colors = ['#8527F0', '#C084FC', '#F59E0B', '#10B981', '#EF4444', '#6366F1', '#EC4899'];
            const datasets = branchesWithData.map((branch, index) => ({
                label: branch.name,
                data: chartData[branch.id] || [],
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
            }));
            
            console.log('Chart datasets:', datasets);
            
            // Create new chart
            feedbackChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: currentFilters.branch === 'all', // Stack only when showing multiple branches
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            stacked: currentFilters.branch === 'all', // Stack only when showing multiple branches
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                stepSize: 1 // Show whole numbers only
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4
                        }
                    }
                }
            });
        }

        // Export CSV functionality
        function exportCSV() {
            try {
                // Get current data
                const totalTickets = document.getElementById('totalTickets').textContent;
                const complaints = document.getElementById('complaintTickets').textContent;
                const suggestions = document.getElementById('suggestionTickets').textContent;
                const inquiries = document.getElementById('inquiryTickets').textContent;
                const compliments = document.getElementById('complimentTickets').textContent;
                const resolved = document.getElementById('ticketResolved').textContent;
                const unresolved = document.getElementById('ticketUnresolved').textContent;
                
                // Create CSV content
                const csvContent = [
                    ['Metric', 'Value'],
                    ['Total Tickets', totalTickets],
                    ['Complaints', complaints],
                    ['Suggestions', suggestions],
                    ['Inquiries', inquiries],
                    ['Compliments', compliments],
                    ['Resolved Tickets', resolved],
                    ['Unresolved Tickets', unresolved],
                    ['Report Period', currentFilters.period],
                    ['Report Range', currentFilters.range],
                    ['Generated On', new Date().toLocaleDateString()]
                ].map(row => row.join(',')).join('\n');
                
                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedfast-report-${currentFilters.period}-${currentFilters.range}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                console.log('CSV export completed');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showError('Failed to export CSV file');
            }
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        // Logout function
        function logout() {
            console.log('Logging out...');
            localStorage.removeItem('clientToken');
            localStorage.removeItem('clientUser');
            window.location.href = '/login';
        }

        // Handle errors globally
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

    </script>
</body>
</html>
