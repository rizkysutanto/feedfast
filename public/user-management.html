<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | FeedFast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .client-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: inline-block;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e5e9;
        }

        .nav-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-width: 80px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .required {
            color: #dc3545;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px 12px;
            border-bottom: 1px solid #e1e5e9;
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.02);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .role-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-client_admin {
            background: #e7f3ff;
            color: #0056b3;
        }

        .role-manager {
            background: #fff3cd;
            color: #856404;
        }

        .role-staff {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            opacity: 0.8;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        /* Alert Messages */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        /* Loading States */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Statistics Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Branch Selection */
        .branch-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .branch-tag {
            background: #e7f3ff;
            color: #0056b3;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .branch-checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 10px;
            background: #f8f9fa;
        }

        .branch-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .branch-checkbox input {
            margin-right: 8px;
            width: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .search-box, .filter-select {
                width: 100%;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 0.8rem;
                margin: 2px;
            }
        }

        /* Action buttons container */
        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }

        /* Toggle Switch for Status */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: #28a745;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <button class="logout-btn" onclick="logout()">Logout</button>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>User Management</h1>
            <p>Manage users and access permissions for your organization</p>
            <div class="client-info" id="clientInfo">
                <strong>Loading client information...</strong>
            </div>
        </div>

        <!-- Alert Messages -->
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>
        <div class="alert alert-warning" id="warningAlert"></div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('list')">User List</button>
            <button class="nav-tab" onclick="switchTab('create')">Add New User</button>
            <button class="nav-tab" onclick="switchTab('statistics')">Statistics</button>
        </div>

        <!-- Statistics Tab -->
        <div id="statisticsTab" class="tab-content" style="display: none;">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">-</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminUsers">-</div>
                    <div class="stat-label">Administrators</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentLogins">-</div>
                    <div class="stat-label">Recent Logins (7d)</div>
                </div>
            </div>
        </div>

        <!-- User List Tab -->
        <div id="listTab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h3>All Users</h3>
                    <button class="btn btn-primary" onclick="switchTab('create')">
                        Add New User
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" id="searchUsers" placeholder="Search users..." 
                               onkeyup="filterUsers()">
                    </div>
                    <div class="filter-select">
                        <select id="roleFilter" onchange="filterUsers()">
                            <option value="">All Roles</option>
                            <option value="client_admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <div class="filter-select">
                        <select id="statusFilter" onchange="filterUsers()">
                            <option value="">All Status</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <button class="btn btn-outline" onclick="loadUsers()">
                        Refresh
                    </button>
                </div>

                <!-- Users Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Phone</th>
                                <th>Branch Access</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create User Tab -->
        <div id="createTab" class="tab-content" style="display: none;">
            <div class="card">
                <h3>Add New User</h3>
                <p style="margin-bottom: 25px; color: #666;">Create a new user account for your organization</p>

                <form id="createUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName">Full Name <span class="required">*</span></label>
                            <input type="text" id="userName" name="user_name" required 
                                   placeholder="Enter user's full name">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email Address <span class="required">*</span></label>
                            <input type="email" id="userEmail" name="email" required 
                                   placeholder="user@example.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="userPassword">Password <span class="required">*</span></label>
                            <input type="password" id="userPassword" name="password" required 
                                   placeholder="Minimum 8 characters">
                        </div>
                        <div class="form-group">
                            <label for="userPhone">Phone Number</label>
                            <input type="tel" id="userPhone" name="phone" 
                                   placeholder="Phone number (optional)">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="userRole">Role <span class="required">*</span></label>
                            <select id="userRole" name="role" required>
                                <option value="">Select Role</option>
                                <option value="client_admin">Administrator</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userStatus">Status <span class="required">*</span></label>
                            <select id="userStatus" name="status" required>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Branch Access</label>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                            Select specific branches for limited access, or leave empty for access to all branches
                        </p>
                        <div id="branchCheckboxes" class="branch-checkbox-group">
                            <div style="text-align: center; color: #666;">Loading branches...</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="onlyAssignedTickets" name="only_assigned_tickets" style="width: auto; margin-right: 8px;">
                            Only show assigned tickets (limit user to see only tickets assigned to them)
                        </label>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Create User
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetCreateForm()">
                            Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserName">Full Name <span class="required">*</span></label>
                            <input type="text" id="editUserName" name="user_name" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserEmail">Email Address <span class="required">*</span></label>
                            <input type="email" id="editUserEmail" name="email" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserRole">Role <span class="required">*</span></label>
                            <select id="editUserRole" name="role" required>
                                <option value="client_admin">Administrator</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUserPhone">Phone Number</label>
                            <input type="tel" id="editUserPhone" name="phone">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Branch Access</label>
                        <div id="editBranchCheckboxes" class="branch-checkbox-group">
                            <div style="text-align: center; color: #666;">Loading branches...</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editOnlyAssignedTickets" name="only_assigned_tickets" style="width: auto; margin-right: 8px;">
                            Only show assigned tickets
                        </label>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Update User
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reset Password</h3>
                <span class="close" onclick="closeResetPasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">Reset password for: <strong id="resetUserName"></strong></p>
                
                <form id="resetPasswordForm">
                    <input type="hidden" id="resetUserId">
                    
                    <div class="form-group">
                        <label for="newPassword">New Password <span class="required">*</span></label>
                        <input type="password" id="newPassword" name="password" required 
                               placeholder="Minimum 8 characters">
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
                        <input type="password" id="confirmPassword" required 
                               placeholder="Re-enter the password">
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="submit" class="btn btn-warning" style="flex: 1;">
                            Reset Password
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'list';
        let allUsers = [];
        let branches = [];
        let clientToken = localStorage.getItem('client_token');
        let currentUser = JSON.parse(localStorage.getItem('client_user') || '{}');

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!clientToken) {
                window.location.href = '/login';
                return;
            }
            
            verifyToken();
            loadBranches();
            loadUsers();
            loadStatistics();
        });

        // Verify token with server
        async function verifyToken() {
            try {
                const response = await fetch('/api/auth/client-verify', {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token verification failed');
                }

                const result = await response.json();
                currentUser = result.user;
                
                // Update header with client info
                document.getElementById('clientInfo').innerHTML = `
                    <strong>Client:</strong> ${currentUser.clientName} | 
                    <strong>User:</strong> ${currentUser.name} (${currentUser.role})
                `;

            } catch (error) {
                console.error('Token verification failed:', error);
                localStorage.removeItem('client_token');
                localStorage.removeItem('client_user');
                window.location.href = '/login';
            }
        }

        // Load branches for dropdown
        async function loadBranches() {
            try {
                const response = await fetch('/api/branches', {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load branches');
                }

                const result = await response.json();
                branches = result.branches;
                
                // Populate branch checkboxes in create form
                populateBranchCheckboxes('branchCheckboxes');
                
            } catch (error) {
                console.error('Error loading branches:', error);
                showAlert('error', 'Failed to load branches: ' + error.message);
            }
        }

        // Populate branch checkboxes
        function populateBranchCheckboxes(containerId) {
            const container = document.getElementById(containerId);
            
            if (branches.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No branches available</div>';
                return;
            }

            container.innerHTML = branches.map(branch => `
                <div class="branch-checkbox">
                    <input type="checkbox" id="${containerId}_${branch.branch_id}" 
                           name="branch_ids" value="${branch.branch_id}">
                    <label for="${containerId}_${branch.branch_id}">
                        ${branch.branch_name} ${branch.branch_code ? '(' + branch.branch_code + ')' : ''}
                    </label>
                </div>
            `).join('');
        }

        // Load users from server
        async function loadUsers() {
            try {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">
                            <div class="spinner"></div>
                            Loading users...
                        </td>
                    </tr>
                `;

                const response = await fetch('/api/users/management', {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const result = await response.json();
                allUsers = result.users;
                displayUsers(allUsers);
                updateStatistics();

            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('error', 'Failed to load users: ' + error.message);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>Error Loading Users</h3>
                            <p>${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>No Users Found</h3>
                            <p>No users match your current filter criteria.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => {
                const branchAccess = getBranchAccessDisplay(user.branch_id);
                const lastLogin = user.last_login ? 
                    new Date(user.last_login).toLocaleDateString() : 'Never';
                
                return `
                    <tr data-user-id="${user.user_id}">
                        <td>
                            <strong>${user.user_name}</strong>
                            ${user.only_assigned_tickets ? '<br><small style="color: #856404;">🎯 Assigned Only</small>' : ''}
                        </td>
                        <td>${user.email}</td>
                        <td>
                            <span class="role-badge role-${user.role}">
                                ${formatRole(user.role)}
                            </span>
                        </td>
                        <td>${user.phone || '-'}</td>
                        <td>${branchAccess}</td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" ${user.status ? 'checked' : ''} 
                                       onchange="toggleUserStatus(${user.user_id}, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-primary btn-sm" onclick="editUser(${user.user_id})">
                                    Edit
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="resetUserPassword(${user.user_id}, '${user.user_name}')">
                                    Reset Pwd
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.user_id}, '${user.user_name}')"
                                        ${user.user_id === currentUser.userId ? 'disabled title="Cannot delete yourself"' : ''}>
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Helper function to get branch access display
        function getBranchAccessDisplay(branchIds) {
            if (!branchIds || branchIds.length === 0) {
                return '<span style="color: #28a745; font-weight: 600;">All Branches</span>';
            }
            
            const branchNames = branchIds.map(id => {
                const branch = branches.find(b => b.branch_id === parseInt(id));
                return branch ? branch.branch_name : `Branch ${id}`;
            });
            
            if (branchNames.length <= 2) {
                return branchNames.map(name => 
                    `<span class="branch-tag">${name}</span>`
                ).join(' ');
            } else {
                return `<span class="branch-tag">${branchNames[0]}</span> <span style="color: #666;">+${branchNames.length - 1} more</span>`;
            }
        }

        // Helper function to format role display
        function formatRole(role) {
            const roleMap = {
                'client_admin': 'Administrator',
                'manager': 'Manager',
                'staff': 'Staff'
            };
            return roleMap[role] || role;
        }

        // Filter users based on search and filter criteria
        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.user_name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm);
                
                const matchesRole = !roleFilter || user.role === roleFilter;
                
                const matchesStatus = !statusFilter || user.status.toString() === statusFilter;

                return matchesSearch && matchesRole && matchesStatus;
            });

            displayUsers(filteredUsers);
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Load data if needed
            if (tabName === 'statistics') {
                loadStatistics();
            }
        }

        // Create new user
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const userData = Object.fromEntries(formData.entries());
                
                // Get selected branch IDs
                const selectedBranches = Array.from(document.querySelectorAll('#branchCheckboxes input:checked'))
                    .map(cb => parseInt(cb.value));
                
                userData.branch_id = selectedBranches.length > 0 ? selectedBranches : null;
                userData.only_assigned_tickets = document.getElementById('onlyAssignedTickets').checked;
                userData.status = userData.status === 'true';

                const response = await fetch('/api/users/management', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'User created successfully!');
                    resetCreateForm();
                    loadUsers(); // Refresh the user list
                    switchTab('list'); // Switch to list tab
                } else {
                    throw new Error(result.message || 'Failed to create user');
                }

            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('error', 'Failed to create user: ' + error.message);
            }
        });

        // Edit user
        async function editUser(userId) {
            try {
                // Get user details
                const response = await fetch(`/api/users/management/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load user details');
                }

                const result = await response.json();
                const user = result.user;

                // Populate edit form
                document.getElementById('editUserId').value = user.user_id;
                document.getElementById('editUserName').value = user.user_name;
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserPhone').value = user.phone || '';
                document.getElementById('editOnlyAssignedTickets').checked = user.only_assigned_tickets;

                // Populate edit branch checkboxes
                populateBranchCheckboxes('editBranchCheckboxes');
                
                // Set selected branches
                if (user.branch_id && user.branch_id.length > 0) {
                    user.branch_id.forEach(branchId => {
                        const checkbox = document.getElementById(`editBranchCheckboxes_${branchId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Show modal
                document.getElementById('editUserModal').style.display = 'block';

            } catch (error) {
                console.error('Error loading user for edit:', error);
                showAlert('error', 'Failed to load user details: ' + error.message);
            }
        }

        // Update user
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const userId = document.getElementById('editUserId').value;
                const formData = new FormData(e.target);
                const userData = Object.fromEntries(formData.entries());
                
                // Get selected branch IDs
                const selectedBranches = Array.from(document.querySelectorAll('#editBranchCheckboxes input:checked'))
                    .map(cb => parseInt(cb.value));
                
                userData.branch_id = selectedBranches.length > 0 ? selectedBranches : null;
                userData.only_assigned_tickets = document.getElementById('editOnlyAssignedTickets').checked;
                userData.status = true; // Keep user active during edit

                const response = await fetch(`/api/users/management/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'User updated successfully!');
                    closeEditModal();
                    loadUsers(); // Refresh the user list
                } else {
                    throw new Error(result.message || 'Failed to update user');
                }

            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('error', 'Failed to update user: ' + error.message);
            }
        });

        // Toggle user status
        async function toggleUserStatus(userId, newStatus) {
            try {
                const response = await fetch(`/api/users/management/${userId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', `User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                    
                    // Update the user in allUsers array
                    const userIndex = allUsers.findIndex(u => u.user_id === userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].status = newStatus;
                    }
                    
                    updateStatistics();
                } else {
                    throw new Error(result.message || 'Failed to update user status');
                }

            } catch (error) {
                console.error('Error updating user status:', error);
                showAlert('error', 'Failed to update user status: ' + error.message);
                
                // Revert the toggle
                const checkbox = document.querySelector(`tr[data-user-id="${userId}"] input[type="checkbox"]`);
                if (checkbox) checkbox.checked = !newStatus;
            }
        }

        // Reset user password
        function resetUserPassword(userId, userName) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetUserName').textContent = userName;
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // Handle password reset form
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const userId = document.getElementById('resetUserId').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showAlert('error', 'Passwords do not match!');
                    return;
                }

                if (newPassword.length < 8) {
                    showAlert('error', 'Password must be at least 8 characters long!');
                    return;
                }

                const response = await fetch(`/api/users/management/${userId}/password`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify({ password: newPassword })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Password reset successfully!');
                    closeResetPasswordModal();
                } else {
                    throw new Error(result.message || 'Failed to reset password');
                }

            } catch (error) {
                console.error('Error resetting password:', error);
                showAlert('error', 'Failed to reset password: ' + error.message);
            }
        });

        // Delete user
        async function deleteUser(userId, userName) {
            if (userId === currentUser.userId) {
                showAlert('warning', 'You cannot delete your own account!');
                return;
            }

            if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/management/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${clientToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'User deleted successfully!');
                    loadUsers(); // Refresh the user list
                } else {
                    throw new Error(result.message || 'Failed to delete user');
                }

            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('error', 'Failed to delete user: ' + error.message);
            }
        }

        // Load and update statistics
        function loadStatistics() {
            updateStatistics();
        }

        function updateStatistics() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.status).length;
            const adminUsers = allUsers.filter(u => u.role === 'client_admin').length;
            
            // Calculate recent logins (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentLogins = allUsers.filter(u => 
                u.last_login && new Date(u.last_login) > sevenDaysAgo
            ).length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('adminUsers').textContent = adminUsers;
            document.getElementById('recentLogins').textContent = recentLogins;
        }

        // Modal functions
        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
            document.getElementById('resetPasswordForm').reset();
        }

        // Reset create form
        function resetCreateForm() {
            document.getElementById('createUserForm').reset();
            // Uncheck all branch checkboxes
            document.querySelectorAll('#branchCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Alert functions
        function showAlert(type, message) {
            hideAllAlerts();
            
            const alertId = type === 'success' ? 'successAlert' : 
                           type === 'warning' ? 'warningAlert' : 'errorAlert';
            
            const alertElement = document.getElementById(alertId);
            alertElement.innerHTML = message;
            alertElement.style.display = 'block';
            
            // Auto-hide success alerts after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
            
            // Scroll to alert
            alertElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideAllAlerts() {
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
            document.getElementById('warningAlert').style.display = 'none';
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('client_token');
                localStorage.removeItem('client_user');
                window.location.href = '/login';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editUserModal');
            const resetModal = document.getElementById('resetPasswordModal');
            
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === resetModal) {
                closeResetPasswordModal();
            }
        }

        // Handle escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
                closeResetPasswordModal();
            }
        });

        // Form validation helpers
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePassword(password) {
            return password.length >= 8;
        }

        // Enhanced form validation for create form
        document.getElementById('userEmail').addEventListener('blur', function() {
            if (this.value && !validateEmail(this.value)) {
                this.style.borderColor = '#dc3545';
                showAlert('error', 'Please enter a valid email address');
            } else {
                this.style.borderColor = '#e1e5e9';
            }
        });

        document.getElementById('userPassword').addEventListener('blur', function() {
            if (this.value && !validatePassword(this.value)) {
                this.style.borderColor = '#dc3545';
                showAlert('error', 'Password must be at least 8 characters long');
            } else {
                this.style.borderColor = '#e1e5e9';
            }
        });

        // Auto-hide alerts when user starts typing
        document.addEventListener('input', function() {
            setTimeout(hideAllAlerts, 3000);
        });

        // Navigation helper (for going back to dashboard)
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + N for new user
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                switchTab('create');
            }
            
            // Ctrl/Cmd + R for refresh
            if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                event.preventDefault();
                loadUsers();
            }
        });

        // Auto-refresh users every 30 seconds when on list tab
        setInterval(() => {
            if (currentTab === 'list' && document.visibilityState === 'visible') {
                loadUsers();
            }
        }, 30000);

        // Handle page visibility change to refresh data when user returns
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentTab === 'list') {
                loadUsers();
            }
        });
    </script>
</body>
</html>
